var Widget=require("../widget"),DAParser=require("../src/daparser"),expect=require("expect.js"),$=require("jquery"),sinon=require("sinon");describe("Widget",function(){var e={};afterEach(function(){for(var t in e)e[t].destroy();e={}}),it("initAttrs",function(){var t=$('<div id="a"></div>').appendTo(document.body),n=Widget.extend({attrs:{element:"#default",foo:"foo",template:"<span></span>",model:{title:"default title",content:"default content"}}}),i=e.a=new n({element:"#a",bar:"bar",template:"<a></a>",model:{title:"title a"}});expect(i.get("bar")).to.equal("bar"),expect(i.get("foo")).to.equal("foo"),expect(i.get("template")).to.equal("<a></a>"),expect(i.get("model").title).to.equal("title a"),expect(i.get("model").content).to.equal("default content"),expect(i.element[0].id).to.equal("a"),t.remove()}),it("parseElement",function(){var t=$('<div id="a"></div>').appendTo(document.body),n=e.widget=new Widget;expect(n.element[0].tagName).to.equal("DIV"),n=e.widget=new Widget({element:"#a"}),expect(n.element[0].id).to.equal("a"),n=e.widget=new Widget({element:document.getElementById("a")}),expect(n.element[0].id).to.equal("a"),n=e.widget=new Widget({element:$("#a")}),expect(n.element[0].id).to.equal("a");try{new Widget({element:"#b"}),expect("应该抛错").to.equal("没有抛错")}catch(i){}n=e.widget=new Widget({element:"#a",template:"<span></span>"}),expect(n.element[0].tagName).to.equal("DIV"),n=e.widget=new Widget({template:"<span></span>"}),expect(n.element[0].tagName).to.equal("SPAN"),t.remove()}),it("parse data attrs",function(){var t=e.widget=new Widget;document.body.setAttribute("data-api","off");var n=DAParser.parseElement(t.element);delete n.widgetCid,expect(n).to.eql({})}),describe("delegateEvents / undelegateEvents",function(){it("delegateEvents()",function(){var t,n=sinon.spy(),i=sinon.spy(),o=sinon.spy(),c=Widget.extend({events:{"click p":"fn1","click li":"fn2","mouseenter span":"fn3"},fn1:n,fn2:i,fn3:function(e){o(),t=e,that=this}}),l=e.widget=new c({template:"<div><p></p><ul><li></li></ul><span></span></div>"}).render();l.$("p").trigger("click"),expect(n.called).to.be.ok(),n.reset(),l.$("li").trigger("click"),expect(i.called).to.be.ok(),i.reset(),l.element.trigger("click"),expect(n.called).not.to.be.ok(),expect(i.called).not.to.be.ok(),n.reset(),i.reset(),l.$("span").trigger("mouseenter"),expect(o.called).to.be.ok(),expect(t.currentTarget.tagName).to.equal("SPAN"),expect(that).to.equal(l)}),it("delegateEvents(eventsObject)",function(){var t=sinon.spy(),n=sinon.spy(),i=Widget.extend({fn1:t}),o=e.widget=new i({template:"<div><p></p><ul><li></li></ul><span></span></div>"}).render();o.delegateEvents({"click p":"fn1","click span":n}),o.$("p").trigger("click"),expect(t.called).to.be.ok(),o.$("span").trigger("click"),expect(t.called).to.be.ok()}),it("delegateEvents(events, handler)",function(){var t=sinon.spy(),n=e.widget=new Widget({template:"<div><p></p><ul><li></li></ul><span></span></div>"}).render();n.delegateEvents("click p",t),n.$("p").trigger("click"),expect(t.called).to.be.ok()}),it("delegateEvents(element, events, handler)",function(){var t=$("<div><p></p></div>"),n=sinon.spy(),i=sinon.spy(),o=e.widget=new Widget({template:"<div><p></p><ul><li></li></ul><span></span></div>"}).render();o.delegateEvents(t,"click",n),o.delegateEvents(t,"click p",i),o.$("p").trigger("click"),expect(i.called).not.to.be.ok(),t.trigger("click"),expect(n.called).to.be.ok(),expect(i.called).not.to.be.ok(),n.reset(),i.reset(),t.find("p").trigger("click"),expect(n.called).to.be.ok(),expect(i.called).to.be.ok()}),it("delegateEvents support normal element",function(){var e=$("<div><p></p></div>")[0],t=sinon.spy(),n=new Widget({template:"<div><p></p><ul><li></li></ul><span></span></div>"}).render();n.delegateEvents(e,"click",t),$(e).trigger("click"),expect(t.called).to.be.ok(),n.destroy()}),it("undelegateEvents()",function(){var t=sinon.spy(),n=sinon.spy(),i=sinon.spy(),o=e.widget=new Widget({template:"<div><p></p><ul><li></li></ul><span></span></div>"}).render();o.delegateEvents({"click p":t,mouseenter:n});var c=$("<div></div>");o.delegateEvents(c,"click",i),o.$("p").trigger("click"),o.element.trigger("mouseenter"),c.trigger("click"),expect(t.called).to.be.ok(),expect(n.called).to.be.ok(),expect(i.called).to.be.ok(),t.reset(),n.reset(),i.reset(),o.undelegateEvents(),o.$("p").trigger("click"),o.element.trigger("mouseenter"),c.trigger("click"),expect(t.called).not.to.be.ok(),expect(n.called).not.to.be.ok(),expect(i.called).not.to.be.ok()}),it("undelegateEvents(events)",function(){var t=sinon.spy(),n=sinon.spy(),i=sinon.spy(),o=e.widget=new Widget({template:"<div><p></p><ul><li></li></ul><span></span></div>"}).render();o.delegateEvents({"click p":t,"click span":n,"click li":i}),o.$("p").trigger("click"),o.$("span").trigger("click"),o.$("li").trigger("click"),expect(t.called).to.be.ok(),expect(n.called).to.be.ok(),expect(i.called).to.be.ok(),t.reset(),n.reset(),i.reset(),o.undelegateEvents("click span"),o.$("p").trigger("click"),o.$("span").trigger("click"),o.$("li").trigger("click"),expect(t.called).to.be.ok(),expect(n.called).not.to.be.ok(),expect(i.called).to.be.ok(),t.reset(),n.reset(),i.reset(),o.undelegateEvents("click"),o.$("p").trigger("click"),o.$("span").trigger("click"),o.$("li").trigger("click"),expect(t.called).not.to.be.ok(),expect(n.called).not.to.be.ok(),expect(i.called).not.to.be.ok()}),it("undelegateEvents(element, events)",function(){var t=$("<div><p></p><ul><li></li></ul><span></span></div>"),n=sinon.spy(),i=sinon.spy(),o=sinon.spy(),c=e.widget=new Widget({template:"<div><p></p><ul><li></li></ul><span></span></div>"}).render();c.delegateEvents(t,"click p",n),c.delegateEvents(t,"click li",i),c.delegateEvents(t,"click span",o),c.undelegateEvents(t,"click li"),t.find("p").trigger("click"),t.find("li").trigger("click"),t.find("span").trigger("click"),expect(n.called).to.be.ok(),expect(i.called).not.to.be.ok(),expect(o.called).to.be.ok(),n.reset(),i.reset(),o.reset(),c.undelegateEvents(t,"click"),t.find("p").trigger("click"),t.find("li").trigger("click"),t.find("span").trigger("click"),expect(n.called).not.to.be.ok(),expect(i.called).not.to.be.ok(),expect(o.called).not.to.be.ok()}),it("#66 extend delegateEvents",function(){var t=sinon.spy(),n=Widget.extend({events:{"click p":t},delegateEvents:function(e,t,i){return n.superclass.delegateEvents.call(this,e,t,i)},undelegateEvents:function(e,t){return n.superclass.undelegateEvents.call(this,e,t)}}),i=e.widget=new n({template:"<div><p></p><ul><li></li></ul><span></span></div>"}).render();i.$("p").trigger("click"),expect(t.called).to.be.ok()})}),it("events hash can be a function",function(){var t=0,n=Widget.extend({events:function(){return{"click h3":"incr","click p":"incr"}},incr:function(){t++}}),i=e.widget=new n({template:"<div><h3></h3><p></p></div>"}).render();i.$("h3").trigger("click"),expect(t).to.equal(1),t=0,i.$("p").trigger("click"),expect(t).to.equal(1)}),it("the default event target is `this.element`",function(){var t=0,n=Widget.extend({events:function(){return{click:"incr"}},incr:function(){t++}}),i=e.widget=(new n).render();i.element.trigger("click"),expect(t).to.equal(1)}),it("parentNode is a document fragment",function(){var e="test"+new Date,t=$('<div id="'+e+'"></div><div></div>');new Widget({element:t.eq(0),parentNode:document.body}).render(),expect(document.getElementById(e).nodeType).to.equal(1)}),it("template in delegate-events",function(){var t=0,n=Widget.extend({attrs:{buttons:"button"},events:{"click p":"incr","click {{attrs.buttons}}":"incr"},incr:function(){t++}}),i=e.a=new n({template:'<div><header>x</header><button>x</button><p>x</p><div id="ttt"></div></div>'}).render();i.$("p").trigger("click"),expect(t).to.equal(1),t=0,$(i.get("buttons")).trigger("click"),expect(t).to.equal(1)}),it("delegate events inherited from ancestors",function(){function t(){n++}var n=0,i=Widget.extend({events:{"click p":t}}),o=i.extend({events:{"click div":t}}),c=e.object=new o({template:"<section><p></p><div></div><span></span></section>",events:{"click span":t}}).render();n=0,c.$("p").trigger("click"),expect(n).to.equal(1),n=0,c.$("div").trigger("click"),expect(n).to.equal(1),n=0,c.$("span").trigger("click"),expect(n).to.equal(1)}),it("ignore null element during delegating events",function(){var e=Widget.extend({attrs:{cancelButton:null},events:{"click {{attrs.cancelButton}}":"incr"}});new e}),it("#76: set default attrs automatically",function(){var t=Widget.extend({attrs:{a:1,b:1},_onRenderA:function(e){this.a=e}}),n=e.a=new t({b:2});expect(n.get("a")).to.equal(1),expect(n.get("b")).to.equal(2),expect(n.a).to.equal(void 0),n.render(),expect(n.a).to.equal(1)}),it("set attribute before render method",function(){var t=[],n=[],i=Widget.extend({attrs:{a:1},_onRenderA:function(e,i){t.push(e),n.push(i)}}),o=e.a=new i({a:2});o.set("a",3),o.render(),expect(t.join()).to.equal("3"),expect(n.join()).to.equal("")}),it("default values in attrs",function(){var t=sinon.spy(),n=sinon.spy(),i=sinon.spy(),o=sinon.spy(),c=sinon.spy(),l=sinon.spy(),a=sinon.spy(),d=sinon.spy(),r=sinon.spy(),p=Widget.extend({attrs:{bool:!1,str:"",str2:"x",obj:{},obj2:{a:1},arr:[],n:null,u:void 0,fn:function(){}},_onRenderBool:t,_onRenderStr:n,_onRenderStr2:i,_onRenderObj:o,_onRenderObj2:c,_onRenderArr:l,_onRenderN:a,_onRenderU:d,_onRenderFn:r}),s=e.a=new p;expect(t.calledOnce).not.to.be.ok(),expect(n.calledOnce).not.to.be.ok(),expect(i.calledOnce).not.to.be.ok(),expect(o.calledOnce).not.to.be.ok(),expect(c.calledOnce).not.to.be.ok(),expect(l.calledOnce).not.to.be.ok(),expect(a.calledOnce).not.to.be.ok(),expect(d.calledOnce).not.to.be.ok(),expect(r.calledOnce).not.to.be.ok(),s.render(),expect(t.calledOnce).to.be.ok(),expect(n.calledOnce).to.be.ok(),expect(i.calledOnce).to.be.ok(),expect(o.calledOnce).to.be.ok(),expect(c.calledOnce).to.be.ok(),expect(l.calledOnce).to.be.ok(),expect(a.calledOnce).not.to.be.ok(),expect(d.calledOnce).not.to.be.ok(),expect(r.calledOnce).to.be.ok(),t.reset(),i.reset();e.b=new p({bool:null,str2:""}).render();expect(t.called).not.to.be.ok(),expect(i.calledOnce).to.be.ok()}),it("call render() after first render",function(){function t(){n++}var n=0,i=Widget.extend({attrs:{a:1},_onRenderA:t}),o=e.a=new i;o.render(),expect(n).to.equal(1),o.render(),expect(n).to.equal(1)}),it("statics white list",function(){var e=Widget.extend();expect(typeof e.autoRender).to.equal("function"),expect(typeof e.autoRenderAll).to.equal("undefined")}),it("data attr api",function(){var t=($('<div id="data-attr-api-test" data-a=1 data-b="b" data-arr="[1,2,3]" data-c="true" data-d=\'{"num": 1, "str": "s", "bool": true}\'></div>').appendTo(document.body),e.t=new Widget({element:"#data-attr-api-test",b:"b2"}));expect(t.get("a")).to.equal(1),expect(t.get("b")).to.equal("b2"),expect(t.get("c")).to.equal(!0),expect(t.get("d").num).to.equal(1),expect(t.get("d").str).to.equal("s"),expect(t.get("d").bool).to.equal(!0),expect(t.get("arr")).to.eql([1,2,3])}),it("onXx setter in attrs",function(){function t(){n++}var n=0,i={a:t},o=Widget.extend({attrs:{onXx:function(){n++},onYy:{setter:function(e){return i[e]}}},test:function(){this.trigger("xx"),this.trigger("yy")}}),c=e.t=new o({onYy:"a"});c.test(),expect(n).to.equal(2)}),it("inherited attrs",function(){var t=Widget.extend({attrs:{a:"",b:null}}),n=t.extend({attrs:{a:"1"}}),i=n.extend({attrs:{a:"2",b:"b"}}),o=e.c=new i;expect(o.get("a")).to.equal("2"),expect(o.get("b")).to.equal("b")}),it("#3: parentNode is a jQuery object",function(){$('<div id="test1"></div>').appendTo("body");var t=e.w=new Widget({parentNode:$("#test1")});t.render(),expect($("#test1 div").html()).to.equal(""),$("#test1").remove()}),it("override object in prototype",function(){var t=Widget.extend({o:{p1:"1"}}),n=t.extend({o:{p2:"2"}}),i=e.c=new n;expect(i.o.p1).to.equal(void 0),expect(i.o.p2).to.equal("2")}),it("mix events object in prototype",function(){var t=Widget.extend({events:{p1:"1"}}),n=t.extend({events:{p2:"2"}}),i=e.c=new n;expect(i.events.p1).to.equal("1"),expect(i.events.p2).to.equal("2")}),it("#38 destroy",function(){var e=new Widget({template:'<div id="destroy"><a></a></div>'}).render();expect(e.element[0]).to.eql($("#destroy")[0]),e.destroy(),expect($("#destroy")[0]).to.be(void 0),expect(e.element).to.be(null)}),it("#25 destroy is called twice",function(){var e=new Widget({template:'<div id="destroy"><a></a></div>'}).render();expect(function(){e.destroy(),e.destroy()}).to.not.throwError()}),it("style attribute",function(){var e=new Widget({style:{padding:"1px"},template:'<div id="destroy"><a></a></div>'}).render();expect(e.element.css("paddingTop")).to.be("1px")}),it("_isTemplate",function(){var e=$('<p id="test"></p>').appendTo(document.body),t=new Widget({element:"#test"});expect(t._isTemplate).not.to.be.ok();var n=new Widget;expect(n._isTemplate).to.be.ok();var i=new Widget({template:"<p></p>"});expect(i._isTemplate).to.be.ok(),e.remove()}),it("attr change callback",function(){var e=sinon.spy(),t=Widget.extend({attrs:{a:1},_onChangeA:e}),n=new t;n.set("a",2),expect(e.calledOnce).to.be.ok()}),it("outerBox",function(){var e=require("./test-widget"),t=$('<div id="testContainer"></div>').appendTo(document.body),n=new e({parentNode:"#testContainer"}).render();expect(n.element.parent()[0]).to.be.ok(),expect(n.element.parent()[0]).to.be(t.children()[0]),expect(n.element.parent().hasClass("arale-text-widget-1_0_0")).to.be.ok(),n.destroy(),expect($(".arale-text-widget-1_0_0")[0]).not.to.be.ok(),t.remove()}),it("set call onRender",function(){var e=sinon.spy(),t=Widget.extend({attrs:{a:1},_onRenderA:e}),n=new t;n.render(),expect(e.calledOnce).to.be.ok(),n.set("a",2),expect(e.calledTwice).to.be.ok()}),it("destroy once",function(){var e=0,t=0,n=Widget.extend({destroy:function(){e++,n.superclass.destroy.call(this)}}),i=n.extend({destroy:function(){t++,i.superclass.destroy.call(this)}}),o=(new i).render();o.destroy(),o.destroy(),expect(e).to.be(1),expect(t).to.be(1)}),it("set attribute to htmlElement",function(){var e=Widget.extend({attrs:{testElement:null}}),t=new e;t.set("testElement",document.body),expect(t.get("testElement")).to.be(document.body)})});var keys=Object.keys;keys||(keys=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t});