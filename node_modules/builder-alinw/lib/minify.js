/* 
* @Author: caoke
* @Date:   2015-11-11 10:06:21
* @Last Modified by:   gbk
* @Last Modified time: 2016-03-22 20:25:11
*/

'use strict';

var fs = require('fs');
var UglifyJs = require('uglify-js');
var CleanCss = require('clean-css');

// minify worker
process.on('message', function(msg) {
    msg.files.forEach(minify.bind(msg));
    process.exit(0);
});

function minify(file) {
    if (/\.js$/.test(file)) {
        console.log('Minify file: ' + file);
        var result = UglifyJs.minify(file, {
            mangle: false,
            compress: {
                warnings: false,
                drop_console: !this.keepConsole
            },
            comments: false
        });
        fs.writeFileSync(file, result.code);
    } else if (/\.css$/.test(file)) {
        console.log('Minify file: ' + file);
        var result = new CleanCss({
            keepSpecialComments: 0,
            compatibility: true,
            advanced: false,
            processImport: true
        }).minify(fs.readFileSync(file, 'utf-8'));
        fs.writeFileSync(file, result.styles);
    }
};
